<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Εκδηλώσεις – Πρωτοπορία UNIC</title>
  <link rel="icon" href="images/logoPROTOPORIAS.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles/general.css">

  <style>
    /* --- Layout helpers to keep footer at bottom --- */
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    body { min-height: 100vh; }
    main { flex: 1; }
    footer { margin-top: auto; }

    /* --- Subnav (same vibe as positions.html) --- */
    .subnav-wrap { padding-top: 96px; } /* account for fixed navbar */
    .title-row { display:flex; align-items:center; gap:1rem; margin: 12px auto 8px; max-width:1100px; padding:0 16px; }
    .title-row .rule { flex:1; height:1px; background:#d7dbe6; }
    .page-title { margin:0; font-size: clamp(28px, 3vw, 40px); letter-spacing:.5px; text-align:center; }

    .subnav {
      max-width:1100px; margin: 0 auto 12px; padding: 8px 12px;
      display:flex; gap:12px; justify-content:center; flex-wrap:wrap;
      border:1px solid #e4e7f0; border-radius:10px; background:#f7f8fb;
    }
    .subnav a {
      text-decoration:none; padding:8px 14px; border-radius:999px;
      font-weight:600; color:#0a3d91; border:1px solid transparent;
    }
    .subnav a.active { background:#0a3d91; color:#fff; border-color:#0a3d91; }

    /* --- Gallery cards (from old images.html) --- */
    .gallery-card img { width:100%; height:100%; object-fit:cover; aspect-ratio:1/1; cursor:pointer; }
    .gallery-card .card-body { padding:.5rem .75rem; }
    .modal-img{ width:100%; height:auto; max-height:80vh; object-fit:contain; }

    /* --- Carousel tweaks (from old events.html) --- */
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
      background-color:#0a3d91; border-radius:50%; padding:20px; background-size:50% 50%;
    }
    .carousel-control-prev, .carousel-control-next { width:auto; }
    .carousel-indicators [data-bs-target] { background-color:#0a3d91; }
  </style>
</head>
<body>
 <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background-color: #0a3d91;">
    <div class="container d-flex align-items-center">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="images/logoPROTOPORIAS.png" alt="Logo" style="height: 60px;">
        <h1>UNIC</h1>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">ΚΕΝΤΡΙΚΗ</a></li>
          <li class="nav-item"><a class="nav-link" href="positions.html">ΘΕΣΕΙΣ</a></li>
          <li class="nav-item"><a class="nav-link" href="neakeenimerosis.html">ΝΕΑ &amp; ΕΝΗΜΕΡΩΣΕΙΣ</a></li>
          <li class="nav-item"><a class="nav-link active" href="events.html">ΕΚΔΗΛΩΣΕΙΣ</a></li>
          <li class="nav-item"><a class="nav-link" href="bluecard.html">BLUE CARD</a></li>
          <li class="nav-item"><a class="nav-link" href="aboutus.html">ΠΟΙΟΙ ΕΙΜΑΣΤΕ</a></li>
        </ul>
      </div>
      <div class="d-none d-lg-block ms-3">
        <a href="member.html" class="btn btn-outline-light">ΓΙΝΕ ΜΕΛΟΣ</a>
      </div>
    </div>
  </nav>


  <!-- Sub Navigation -->
  <div class="subnav-wrap">
    <div class="title-row">
      <div class="rule"></div>
      <h1 class="page-title" style="margin:0; font-weight:800; font-size:clamp(28px, 3vw, 40px); letter-spacing:.5px; text-align:center; color:#2a3b57;">ΕΚΔΗΛΩΣΕΙΣ</h1>
      <div class="rule"></div>
    </div>

    <nav class="subnav" aria-label="Υπομενού Εκδηλώσεων">
      <a href="#images"   id="tab-images">ΕΙΚΟΝΕΣ</a>
      <a href="#upcoming" id="tab-upcoming">UPCOMING</a>
    </nav>
  </div>

  <main class="page-container">
    <!-- ========== ΕΙΚΟΝΕΣ ========== -->
    <section id="images" class="py-4">
      <div class="container">
        <h2 class="text-center mb-4">Εικόνες</h2>
        <p id="galleryHelpText">Επιλέξτε τίτλο για να δείτε εικόνες.</p>

        <div class="mb-3">
          <button id="backToTitles" class="btn btn-outline-secondary d-none">Πίσω</button>
        </div>

        <div id="galleryGrid" class="row g-3">
          <!-- items injected here -->
        </div>

        <div class="text-center mt-3"></div>
      </div>
    </section>

    <!-- ========== UPCOMING (old events list) ========== -->
    <section id="upcoming" class="py-4 d-none">
      <div class="container">
        <h2 class="text-center mb-4">Upcoming</h2>
        <div id="eventsWrap" class="vstack gap-4"></div>
        <div class="text-center mt-3">
          <button id="loadMoreEvents" class="btn btn-outline-primary d-none">Φόρτωσε περισσότερα</button>
        </div>
      </div>
    </section>
  </main>

   <!-- Footer -->
<footer class="text-light py-4" style="background-color: #0a3d91;">
  <div class="container text-center">
    <p class="mb-1">&copy; 2025 Φοιτιτική Παράταξη Πρωτοπορία Πανεπιστημίου Λευκωσίας. All rights reserved.</p>
    
   <!-- Social Media Icons -->
<div class="d-flex justify-content-center gap-3 mb-2">
  <a href="https://www.instagram.com/protoporiaunic/" target="_blank">
    <img src="images/instagram-new--v2.png" style="height: 30px;">
  </a>
  <a href="https://www.tiktok.com/@fpkprotoporia.unic" target="_blank">
    <img src="images/tiktok.png" style="height: 30px;">
  </a>
</div>


    <!-- Contact Links -->
    <p class="mb-0">
      <a href="mailto:protoporiafpkunic@gmail.com" class="text-warning text-decoration-none">
        Contact us
      </a>
    </p>
    
    <!-- Credits -->
    <div style="font-size: 13px; margin-top: 5px;">
      Made and designed by <a href="https://koumasweb.com" target="_blank" class="text-warning">KoumasWeb</a> ©
    </div>
  </div>
</footer>

  <!-- Image Modal -->
  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="imgModalTitle" class="modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Κλείσιμο"></button>
        </div>
        <div class="modal-body text-center">
          <img id="imgModalImg" class="modal-img" alt="gallery image">
          <p id="imgModalCaption" class="text-muted mt-3 mb-0"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, getDocs, startAfter
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Firebase config (public; writes are protected by rules)
    const firebaseConfig = {
      apiKey: "AIzaSyCvqbwjAOg0eKii7AcbLCDY93Vws5bUdfs",
      authDomain: "protoporia-unic.firebaseapp.com",
      projectId: "protoporia-unic",
      storageBucket: "protoporia-unic.firebasestorage.app",
      messagingSenderId: "694349187986",
      appId: "1:694349187986:web:93ef873c8f48b929b20f4b"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ---------- Subnav routing ----------
    const tabs = {
      images:   { tab: document.getElementById('tab-images'),   section: document.getElementById('images') },
      upcoming: { tab: document.getElementById('tab-upcoming'), section: document.getElementById('upcoming') }
    };

    function activate(which){
      Object.entries(tabs).forEach(([key, {tab, section}])=>{
        const on = (key === which);
        tab.classList.toggle('active', on);
        section.classList.toggle('d-none', !on);
      });
      // store hash without scrolling jump on first load
      if (location.hash !== '#'+which) history.replaceState(null, '', '#'+which);
    }

    function initFromHash(){
      const h = (location.hash || '').replace('#','');
      activate(h === 'upcoming' ? 'upcoming' : 'images');
    }

    tabs.images.tab.addEventListener('click', (e)=>{ e.preventDefault(); activate('images'); });
    tabs.upcoming.tab.addEventListener('click', (e)=>{ e.preventDefault(); activate('upcoming'); });
    window.addEventListener('hashchange', initFromHash);
    initFromHash();

    // ---------- Shared utils ----------
    const escapeHtml = (s)=> (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    const fmtDate = (ts) => {
      try { const d = ts?.toDate ? ts.toDate() : null;
            return d ? d.toLocaleDateString('el-GR', { year:'numeric', month:'long', day:'numeric' }) : ''; }
      catch { return ''; }
    };

    // ---------- ΕΙΚΟΝΕΣ (titles first, then images by title) ----------
    const grid = document.getElementById('galleryGrid');
    const helpText = document.getElementById('galleryHelpText');
    const backBtn = document.getElementById('backToTitles');

    // Local state: map titles -> images
    const galleryByTitle = new Map();
    const GALLERY_PAGE = 50;
    let galleryLastDoc = null;
    let galleryLoadedAll = false;

    function renderImageCard({ imageUrl, title="", caption="" }) {
      const col = document.createElement('div');
      col.className = "col-6 col-md-4 col-lg-3";
      col.innerHTML = `
        <div class="card h-100 shadow-sm gallery-card">
          <img src="${imageUrl}" alt="${escapeHtml(title||'Εικόνα')}" loading="lazy">
          ${(title || caption) ? `
          <div class="card-body py-2">
            ${title ? `<h6 class="card-title mb-1">${escapeHtml(title)}</h6>` : ""}
            ${caption ? `<p class="card-text small text-muted mb-0">${escapeHtml(caption)}</p>` : ""}
          </div>` : ""}
        </div>
      `;
      const img = col.querySelector('img');
      img.addEventListener('click', () => openModal({ imageUrl, title, caption }));
      grid.appendChild(col);
    }

    function openModal({ imageUrl, title="", caption="" }) {
      const modalEl = document.getElementById('imgModal');
      document.getElementById('imgModalTitle').textContent = title || 'Προβολή εικόνας';
      document.getElementById('imgModalImg').src = imageUrl;
      document.getElementById('imgModalCaption').textContent = caption || '';
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    function clearGrid(){ grid.innerHTML = ''; }

    async function loadAllGalleryDocs(){
      while(!galleryLoadedAll){
        let qy = query(collection(db, 'gallery'), orderBy('createdAt','desc'), limit(GALLERY_PAGE));
        if (galleryLastDoc) {
          qy = query(collection(db, 'gallery'), orderBy('createdAt','desc'), startAfter(galleryLastDoc), limit(GALLERY_PAGE));
        }

        const snap = await getDocs(qy);
        if (snap.empty) { galleryLoadedAll = true; break; }

        snap.forEach(docSnap => {
          const d = docSnap.data();
          if (!d?.imageUrl) return;
          const title = (d.title || 'Χωρίς τίτλο').trim();
          const arr = galleryByTitle.get(title) || [];
          arr.push({ imageUrl: d.imageUrl, title: d.title || '', caption: d.caption || '' });
          galleryByTitle.set(title, arr);
        });

        galleryLastDoc = snap.docs[snap.docs.length - 1];
        if (snap.size < GALLERY_PAGE) galleryLoadedAll = true;
      }
    }

    function renderTitles(){
      clearGrid();
      backBtn.classList.add('d-none');
      helpText.textContent = 'Επιλέξτε τίτλο για να δείτε εικόνες.';

      const titles = Array.from(galleryByTitle.keys()).sort((a,b)=> a.localeCompare(b, 'el'));
      if (!titles.length){
        const msg = document.createElement('div');
        msg.className = 'text-center text-muted';
        msg.textContent = 'Δεν υπάρχουν εικόνες προς το παρόν.';
        grid.appendChild(msg);
        return;
      }

      titles.forEach(t => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-8 col-lg-6 mx-auto';
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary w-100 text-start';
        btn.style.marginBottom = '8px';
        btn.textContent = t;
        btn.addEventListener('click', ()=> showTitle(t));
        col.appendChild(btn);
        grid.appendChild(col);
      });
    }

    function showTitle(title){
      clearGrid();
      backBtn.classList.remove('d-none');
      helpText.textContent = 'Κάντε κλικ σε οποιαδήποτε εικόνα για μεγαλύτερη προβολή.';
      const arr = galleryByTitle.get(title) || [];
      if (!arr.length){
        const msg = document.createElement('div');
        msg.className = 'text-center text-muted';
        msg.textContent = 'Δεν βρέθηκαν εικόνες για αυτόν τον τίτλο.';
        grid.appendChild(msg);
        return;
      }
      arr.forEach(renderImageCard);
    }

    backBtn.addEventListener('click', renderTitles);

    (async function initGallery(){
      await loadAllGalleryDocs();
      renderTitles();
    })();

    // ---------- UPCOMING (former events.html) ----------
    const wrap    = document.getElementById('eventsWrap');
    const loadMoreEvents = document.getElementById('loadMoreEvents');
    const PAGE_EVENTS = 5;
    let lastEventDoc = null;
    let eventsEnd = false;

    function buildEventCard(id, d) {
      const title = d.title || 'Χωρίς τίτλο';
      const description = d.description || '';
      const dateStr = fmtDate(d.createdAt);
      const mediaArr = Array.isArray(d.media) ? d.media : [];

      const div = document.createElement('div');
      div.className = "card shadow-sm";
      div.innerHTML = `
        <div class="card-body">
          <h4 class="card-title">${escapeHtml(title)}</h4>
          <p class="text-muted mb-2">${dateStr}</p>
          ${description ? `<p class="mb-3">${escapeHtml(description)}</p>` : ''}

          <div id="carousel-${id}" class="carousel slide" data-bs-ride="false">
            <div class="carousel-indicators" id="carousel-indicators-${id}"></div>
            <div class="carousel-inner" id="carousel-inner-${id}">
              ${mediaArr.length ? '' : `
                <div class="carousel-item active">
                  <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center">
                    <div class="text-muted">Δεν υπάρχουν πολυμέσα.</div>
                  </div>
                </div>`}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-${id}" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carousel-${id}" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      `;

      if (mediaArr.length) {
        const inner = div.querySelector('#carousel-inner-' + id);
        const indicators = div.querySelector('#carousel-indicators-' + id);
        let first = true;
        mediaArr.forEach((m, index) => {
          const isVideo = (m?.contentType || '').startsWith('video/');
          const item = document.createElement('div');
          item.className = 'carousel-item' + (first ? ' active' : '');
          item.innerHTML = isVideo
            ? `<div class="ratio ratio-16x9">
                 <video src="${m.url}" class="d-block w-100" controls playsinline></video>
               </div>`
            : `<img src="${m.url}" class="d-block w-100" alt="media" loading="lazy" style="object-fit:cover; max-height:600px;">`;
          inner.appendChild(item);

          const indicator = document.createElement('button');
          indicator.type = "button";
          indicator.setAttribute("data-bs-target", "#carousel-" + id);
          indicator.setAttribute("data-bs-slide-to", index);
          indicator.className = first ? "active" : "";
          indicator.setAttribute("aria-label", "Slide " + (index+1));
          indicators.appendChild(indicator);

          first = false;
        });
      }

      return div;
    }

    async function loadEventsPage() {
      if (eventsEnd) return;

      let qy = query(collection(db, 'events'), orderBy('createdAt','desc'), limit(PAGE_EVENTS));
      if (lastEventDoc) {
        qy = query(collection(db, 'events'), orderBy('createdAt','desc'), startAfter(lastEventDoc), limit(PAGE_EVENTS));
      }

      const snap = await getDocs(qy);
      if (snap.empty) {
        eventsEnd = true;
        loadMoreEvents.classList.add('d-none');
        return;
      }

      const docs = snap.docs;
      for (const ev of docs) {
        const d = ev.data();
        const card = buildEventCard(ev.id, d);
        wrap.appendChild(card);
      }

      lastEventDoc = docs[docs.length - 1];
      loadMoreEvents.classList.toggle('d-none', docs.length < PAGE_EVENTS);
    }

    loadMoreEvents.addEventListener('click', loadEventsPage);
    loadEventsPage();
  </script>
</body>
</html>

